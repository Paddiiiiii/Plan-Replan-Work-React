<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAG çŸ¥è¯†å›¾è°±å¯è§†åŒ– - å¢å¼ºç‰ˆ</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .stat-item .number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        .stat-item .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .panel-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title::before {
            content: "â–¸";
            font-size: 1.2em;
        }
        
        #graph-container {
            width: 100%;
            height: 600px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .text-panel {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .highlighted-text {
            line-height: 1.8;
            font-size: 14px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .text-normal {
            color: #333;
        }
        
        .text-entity {
            background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: inline-block;
            margin: 0 1px;
        }
        
        .text-entity:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        .text-entity::after {
            content: attr(data-type);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            margin-bottom: 5px;
        }
        
        .text-entity:hover::after {
            opacity: 1;
        }
        
        .steps-panel {
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        
        .steps-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .step-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
            animation: slideIn 0.5s ease-out;
        }
        
        .step-item:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .step-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        .step-description {
            color: #666;
            margin-top: 10px;
            line-height: 1.6;
        }
        
        .step-entities, .step-relations {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .entity-tag, .relation-tag {
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .entity-tag:hover, .relation-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-label {
            font-size: 0.9em;
            color: #666;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ KAG çŸ¥è¯†å›¾è°±å¯è§†åŒ–</h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="number" id="node-count">0</span>
                    <span class="label">å®ä½“èŠ‚ç‚¹</span>
                    <span class="label" id="node-total" style="font-size: 0.8em; opacity: 0.7;"></span>
                </div>
                <div class="stat-item">
                    <span class="number" id="edge-count">0</span>
                    <span class="label">å…³ç³»è¾¹</span>
                    <span class="label" id="edge-total" style="font-size: 0.8em; opacity: 0.7;"></span>
                </div>
                <div class="stat-item">
                    <span class="number" id="type-count">0</span>
                    <span class="label">å®ä½“ç±»å‹</span>
                </div>
            </div>
            <div id="sampling-notice" style="margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.2); border-radius: 5px; display: none;">
                <span style="font-size: 0.9em;">âš ï¸ æ•°æ®é‡è¾ƒå¤§ï¼Œä»…æ˜¾ç¤ºéƒ¨åˆ†é‡è¦èŠ‚ç‚¹å’Œå…³ç³»ï¼ˆæŒ‰è¿æ¥åº¦æ’åºï¼‰</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <div class="panel-title">çŸ¥è¯†å›¾è°±</div>
                <div class="controls">
                    <button class="control-btn" onclick="resetView()">é‡ç½®è§†å›¾</button>
                    <button class="control-btn" onclick="fitView()">é€‚åº”çª—å£</button>
                </div>
                <div id="graph-container"></div>
                <div class="legend" id="legend"></div>
            </div>
            
            <div class="panel">
                <div class="panel-title">åŸæ–‡é«˜äº®</div>
                <div class="text-panel">
                    <div class="highlighted-text" id="highlighted-text">
                        <span class="text-entity" data-entity-id="å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ" data-type="å†›äº‹å•ä½" style="background: linear-gradient(120deg, #FF6B6B88 0%, #FF6B6BAA 100%); padding: 2px 4px; border-radius: 3px; cursor: pointer;">å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ</span><span class="text-normal">ä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥è¯†åŒ–çš„é—®é¢˜ï¼Œæå‡çŸ¥è¯†çš„è‡ªé€‚åº”å­¦ä¹ ä¸æ¼”åŒ–èƒ½åŠ›ä»¥åŠè®­ç»ƒè¿‡ç¨‹ä¸­çš„ç²¾å‡†çŸ¥è¯†ç»„ç»‡ä¸æœåŠ¡èƒ½åŠ›ã€‚</span>
                    </div>
                </div>
            </div>
            
            <div class="panel steps-panel">
                <div class="panel-title">æŠ½å–è¿‡ç¨‹</div>
                <div class="steps-container" id="steps-container">
                    
                <div class="step-item" style="animation-delay: 0.1s">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-name">å®ä½“è¯†åˆ«</div>
                    </div>
                    <div class="step-description">ä»æ–‡æœ¬ä¸­è¯†åˆ«å‡º 2 ä¸ªå®ä½“</div>
                    <div class="step-entities"><span class="entity-tag">å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ (å†›äº‹å•ä½)</span><span class="entity-tag">å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥... (Chunk)</span></div>
                    
                </div>
            
                <div class="step-item" style="animation-delay: 0.2s">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-name">å…³ç³»æŠ½å–</div>
                    </div>
                    <div class="step-description">æŠ½å–äº† 1 æ¡å…³ç³»</div>
                    
                    <div class="step-relations"><span class="relation-tag">å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ --[source]--> 514a240c-2130-46d5-9d58-7c3a69efce38</span></div>
                </div>
            
                <div class="step-item" style="animation-delay: 0.30000000000000004s">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-name">å›¾è°±æ„å»º</div>
                    </div>
                    <div class="step-description">æ„å»ºåŒ…å« 2 ä¸ªèŠ‚ç‚¹å’Œ 1 æ¡è¾¹çš„çŸ¥è¯†å›¾è°±</div>
                    
                    
                </div>
            
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å›¾æ•°æ®
        const graphData = {
  "nodes": [
    {
      "id": "514a240c-2130-46d5-9d58-7c3a69efce38",
      "label": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥...",
      "type": "Chunk",
      "color": "#4ECDC4",
      "properties": {
        "id": "514a240c-2130-46d5-9d58-7c3a69efce38",
        "name": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥...",
        "content": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥...\nå†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥è¯†åŒ–çš„é—®é¢˜ï¼Œæå‡çŸ¥è¯†çš„è‡ªé€‚åº”å­¦ä¹ ä¸æ¼”åŒ–èƒ½åŠ›ä»¥åŠè®­ç»ƒè¿‡ç¨‹ä¸­çš„ç²¾å‡†çŸ¥è¯†ç»„ç»‡ä¸æœåŠ¡èƒ½åŠ›ã€‚"
      },
      "size": 20,
      "degree": 1
    },
    {
      "id": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ",
      "label": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ",
      "type": "å†›äº‹å•ä½",
      "color": "#FF6B6B",
      "properties": {},
      "size": 20,
      "degree": 1
    }
  ],
  "edges": [
    {
      "from": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ",
      "to": "514a240c-2130-46d5-9d58-7c3a69efce38",
      "label": "source",
      "color": "#9B59B6",
      "properties": {}
    }
  ],
  "nodeTypes": [
    "å†›äº‹å•ä½",
    "Chunk"
  ],
  "relationTypes": [
    "source"
  ],
  "stats": {
    "total_nodes": 2,
    "total_edges": 1,
    "displayed_nodes": 2,
    "displayed_edges": 1,
    "sampled": false
  }
};
        const highlightedText = {"original": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥è¯†åŒ–çš„é—®é¢˜ï¼Œæå‡çŸ¥è¯†çš„è‡ªé€‚åº”å­¦ä¹ ä¸æ¼”åŒ–èƒ½åŠ›ä»¥åŠè®­ç»ƒè¿‡ç¨‹ä¸­çš„ç²¾å‡†çŸ¥è¯†ç»„ç»‡ä¸æœåŠ¡èƒ½åŠ›ã€‚", "segments": [{"text": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ", "type": "entity", "entityName": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ", "entityType": "å†›äº‹å•ä½", "entityId": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ", "color": "#FF6B6B"}, {"text": "ä½œä¸ºæ•´ä¸ªè®­ç»ƒä»¿çœŸäº¤äº’èµ„æºå’ŒæœåŠ¡å¹³å°çš„æ•°æ®çŸ¥è¯†åº•åº§ï¼Œç€é‡è§£å†³è®­ç»ƒæ•°æ®å’Œä¿¡æ¯çŸ¥è¯†åŒ–çš„é—®é¢˜ï¼Œæå‡çŸ¥è¯†çš„è‡ªé€‚åº”å­¦ä¹ ä¸æ¼”åŒ–èƒ½åŠ›ä»¥åŠè®­ç»ƒè¿‡ç¨‹ä¸­çš„ç²¾å‡†çŸ¥è¯†ç»„ç»‡ä¸æœåŠ¡èƒ½åŠ›ã€‚", "type": "normal"}], "entities": {"å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ": {"type": "å†›äº‹å•ä½", "id": "å†›äº‹è®­ç»ƒäº¤äº’çŸ¥è¯†å¤„ç†åˆ†ç³»ç»Ÿ", "color": "#FF6B6B"}}};
        
        // åˆå§‹åŒ–ç½‘ç»œå›¾
        let network = null;
        let physicsEnabled = true; // é»˜è®¤å¯ç”¨ç‰©ç†å¼•æ“
        let nodeCount = 0;
        let edgeCount = 0;
        
        function initGraph() {
            const container = document.getElementById('graph-container');
            
            // è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
            console.log("=== å¼€å§‹åˆå§‹åŒ–å›¾è¡¨ ===");
            console.log("graphData:", graphData);
            console.log("graphData.nodes:", graphData.nodes);
            console.log("graphData.edges:", graphData.edges);
            console.log("èŠ‚ç‚¹æ•°é‡:", graphData.nodes ? graphData.nodes.length : 0);
            console.log("è¾¹æ•°é‡:", graphData.edges ? graphData.edges.length : 0);
            
            // éªŒè¯æ•°æ®
            if (!graphData) {
                console.error("graphData æœªå®šä¹‰");
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;"><h3>æ•°æ®æœªå®šä¹‰</h3><p>graphData å˜é‡æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥æ•°æ®ä¼ é€’</p></div>';
                return;
            }
            
            if (!graphData.nodes || !Array.isArray(graphData.nodes)) {
                console.error("graphData.nodes æ— æ•ˆ:", graphData.nodes);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;"><h3>èŠ‚ç‚¹æ•°æ®æ— æ•ˆ</h3><p>graphData.nodes ä¸æ˜¯æ•°ç»„æˆ–ä¸å­˜åœ¨</p></div>';
                return;
            }
            
            if (graphData.nodes.length === 0) {
                console.error("èŠ‚ç‚¹æ•°ç»„ä¸ºç©º");
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;"><h3>æ— èŠ‚ç‚¹æ•°æ®</h3><p>èŠ‚ç‚¹æ•°ç»„ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºå¯è§†åŒ–</p><p>è¯·æ£€æŸ¥æ•°æ®æº</p></div>';
                document.getElementById('node-count').textContent = '0';
                document.getElementById('edge-count').textContent = '0';
                document.getElementById('type-count').textContent = '0';
                return;
            }
            
            console.log("âœ… æ•°æ®éªŒè¯é€šè¿‡ï¼Œå¼€å§‹åˆ›å»ºèŠ‚ç‚¹å’Œè¾¹");
            
            // å…ˆè®¡ç®—æ•°æ®è§„æ¨¡ï¼ˆç”¨äºå†³å®šå­—ä½“å¤§å°ç­‰ï¼‰
            const nodeCount = graphData.nodes.length;
            const edgeCount = graphData.edges ? graphData.edges.length : 0;
            const isLargeGraph = nodeCount > 200 || edgeCount > 500;
            
            console.log(`æ•°æ®è§„æ¨¡: ${nodeCount} èŠ‚ç‚¹, ${edgeCount} è¾¹, å¤§æ•°æ®é›†: ${isLargeGraph}`);
            
            // å¤„ç†èŠ‚ç‚¹æ•°æ®ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
            const processedNodes = [];
            for (let i = 0; i < graphData.nodes.length; i++) {
                const node = graphData.nodes[i];
                try {
                    // éªŒè¯èŠ‚ç‚¹æ•°æ®ï¼šç¡®ä¿idå­˜åœ¨ä¸”ä¸ä¸ºç©º
                    if (!node) {
                        console.warn(`èŠ‚ç‚¹ ${i} ä¸º null æˆ– undefined`);
                        continue;
                    }
                    
                    // æ£€æŸ¥idæ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
                    const nodeId = node.id;
                    if (nodeId === null || nodeId === undefined || nodeId === '') {
                        console.warn(`èŠ‚ç‚¹ ${i} çš„ id æ— æ•ˆ:`, nodeId, node);
                        continue;
                    }
                    
                    // ç›´æ¥ä½¿ç”¨èŠ‚ç‚¹æ•°æ®ï¼Œvis.jsä¼šè‡ªåŠ¨å¤„ç†ï¼ˆå‚è€ƒPyvisæ–¹å¼ï¼‰
                    const nodeId = node.id;
                    const nodeLabel = node.label || node.name || String(nodeId) || 'Unknown';
                    
                    processedNodes.push({
                        id: nodeId,  // vis.jsæ”¯æŒå­—ç¬¦ä¸²å’Œæ•°å­—ï¼Œä¸åšå¼ºåˆ¶è½¬æ¢
                        label: String(nodeLabel),  // labelå¿…é¡»æ˜¯å­—ç¬¦ä¸²
                        color: {
                            background: node.color || '#888888',
                            border: '#2B2B2B',
                            highlight: {
                                background: node.color || '#888888',
                                border: '#000000'
                            }
                        },
                        size: node.size || 20,
                        font: {
                            size: isLargeGraph ? 12 : 14,
                            face: 'Microsoft YaHei'
                        },
                        shape: 'box',
                        title: `${node.type || 'Unknown'}\n${JSON.stringify(node.properties || {}, null, 2)}`
                    });
                } catch (error) {
                    console.error(`å¤„ç†èŠ‚ç‚¹ ${i} æ—¶å‡ºé”™:`, error, node);
                }
            }
            
            console.log(`å¤„ç†åçš„èŠ‚ç‚¹æ•°: ${processedNodes.length} / ${graphData.nodes.length}`);
            
            if (processedNodes.length === 0) {
                console.error("å¤„ç†åçš„èŠ‚ç‚¹æ•°ä¸º0ï¼Œæ— æ³•ç»§ç»­");
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;"><h3>èŠ‚ç‚¹æ•°æ®å¤„ç†å¤±è´¥</h3><p>æ‰€æœ‰èŠ‚ç‚¹æ•°æ®å¤„ç†åéƒ½æ— æ•ˆ</p><p>è¯·æ£€æŸ¥æ•°æ®æ ¼å¼</p></div>';
                return;
            }
            
            const nodes = new vis.DataSet(processedNodes);
            
            // å¤„ç†è¾¹æ•°æ®ï¼Œç¡®ä¿fromå’Œtoéƒ½å­˜åœ¨ï¼ˆä½¿ç”¨å¤„ç†åçš„èŠ‚ç‚¹IDï¼Œä¿æŒåŸå§‹ç±»å‹ï¼‰
            const validEdges = [];
            const nodeIds = new Set(processedNodes.map(n => n.id));  // ä¿æŒåŸå§‹ç±»å‹ï¼Œä¸åšå­—ç¬¦ä¸²è½¬æ¢
            
            console.log(`èŠ‚ç‚¹IDé›†åˆå¤§å°: ${nodeIds.size}`);
            if (nodeIds.size > 0) {
                console.log("å‰5ä¸ªèŠ‚ç‚¹ID:", Array.from(nodeIds).slice(0, 5));
            }
            
            if (graphData.edges && graphData.edges.length > 0) {
                console.log(`å¼€å§‹å¤„ç† ${graphData.edges.length} æ¡è¾¹`);
                for (let i = 0; i < graphData.edges.length; i++) {
                    const edge = graphData.edges[i];
                    try {
                        // ç›´æ¥ä½¿ç”¨edge.fromå’Œedge.toï¼Œvis.jsä¼šè‡ªåŠ¨åŒ¹é…ï¼ˆå‚è€ƒPyvisæ–¹å¼ï¼‰
                        const fromId = edge.from || edge.from_id;
                        const toId = edge.to || edge.to_id;
                        
                        // ç¡®ä¿fromå’Œtoå­˜åœ¨ä¸”åœ¨èŠ‚ç‚¹åˆ—è¡¨ä¸­ï¼ˆä½¿ç”¨åŸå§‹ç±»å‹æ¯”è¾ƒï¼‰
                        if (fromId !== null && fromId !== undefined && 
                            toId !== null && toId !== undefined &&
                            nodeIds.has(fromId) && nodeIds.has(toId)) {
                            validEdges.push({
                                from: fromId,  // ä¿æŒåŸå§‹ç±»å‹ï¼Œvis.jsä¼šè‡ªåŠ¨åŒ¹é…
                                to: toId,
                                label: String(edge.label || ''),
                                color: {
                                    color: edge.color || "#666666",
                                    highlight: edge.color || "#666666"
                                },
                                width: isLargeGraph ? 1 : 2,
                                arrows: {
                                    to: {
                                        enabled: true,
                                        type: 'arrow'
                                    }
                                },
                                font: {
                                    size: isLargeGraph ? 10 : 12,
                                    face: 'Microsoft YaHei',
                                    align: 'middle'
                                },
                                smooth: {
                                    type: isLargeGraph ? 'straightCross' : 'cubicBezier',
                                    roundness: 0.4
                                }
                            });
                        }
                    } catch (error) {
                        console.warn(`å¤„ç†è¾¹ ${i} æ—¶å‡ºé”™:`, error, edge);
                    }
                }
                console.log(`âœ… æœ‰æ•ˆè¾¹æ•°: ${validEdges.length} / ${graphData.edges.length}`);
            } else {
                console.warn("è¾¹æ•°æ®ä¸ºç©ºæˆ–ä¸å­˜åœ¨");
            }
            
            const edges = new vis.DataSet(validEdges);
            
            const data = { nodes: nodes, edges: edges };
            
            // å†æ¬¡éªŒè¯
            if (nodes.length === 0) {
                console.error("No valid nodes after processing");
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;"><h3>èŠ‚ç‚¹æ•°æ®æ— æ•ˆ</h3><p>æ— æ³•åˆ›å»ºèŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼</p></div>';
                return;
            }
            
            console.log(`âœ… å‡†å¤‡åˆ›å»ºç½‘ç»œå›¾: ${processedNodes.length} ä¸ªèŠ‚ç‚¹, ${validEdges.length} æ¡è¾¹`);
            
            // æ ¹æ®æ•°æ®é‡ä¼˜åŒ–é…ç½®ï¼ˆä½¿ç”¨å®é™…å¤„ç†åçš„æ•°æ®ï¼‰
            nodeCount = processedNodes.length;
            edgeCount = validEdges.length;
            const isLargeGraph = nodeCount > 200 || edgeCount > 500;
            const isVeryLargeGraph = nodeCount > 500 || edgeCount > 2000;
            
            console.log(`å›¾è§„æ¨¡: ${nodeCount} èŠ‚ç‚¹, ${edgeCount} è¾¹, å¤§æ•°æ®é›†: ${isLargeGraph}, è¶…å¤§æ•°æ®é›†: ${isVeryLargeGraph}`);
            
            const options = {
                physics: {
                    enabled: physicsEnabled, // æ ¹æ®ç”¨æˆ·é€‰æ‹©å¯ç”¨/å…³é—­ç‰©ç†å¼•æ“
                    stabilization: {
                        iterations: isVeryLargeGraph ? 100 : (isLargeGraph ? 150 : 200), // å¤§æ•°æ®é›†é€‚å½“å‡å°‘è¿­ä»£æ¬¡æ•°
                        updateInterval: isVeryLargeGraph ? 50 : (isLargeGraph ? 25 : 5),
                        onlyDynamicEdges: isVeryLargeGraph // è¶…å¤§æ•°æ®é›†åªç¨³å®šåŠ¨æ€è¾¹
                    },
                    barnesHut: {
                        gravitationalConstant: isVeryLargeGraph ? -3000 : -2000,
                        centralGravity: isVeryLargeGraph ? 0.2 : 0.3,
                        springLength: isVeryLargeGraph ? 100 : (isLargeGraph ? 150 : 200),
                        springConstant: isVeryLargeGraph ? 0.02 : (isLargeGraph ? 0.03 : 0.04),
                        damping: isVeryLargeGraph ? 0.15 : (isLargeGraph ? 0.12 : 0.09),
                        avoidOverlap: isVeryLargeGraph ? 1 : (isLargeGraph ? 1 : 0),
                        theta: isVeryLargeGraph ? 1.2 : 0.5 // è¶…å¤§æ•°æ®é›†ä½¿ç”¨æ›´å¤§çš„thetaå€¼æé«˜æ€§èƒ½
                    },
                    solver: 'barnesHut', // å§‹ç»ˆä½¿ç”¨barnesHutï¼Œæ€§èƒ½æ›´å¥½
                    timestep: isVeryLargeGraph ? 0.25 : (isLargeGraph ? 0.35 : 0.5)
                },
                interaction: {
                    hover: !isVeryLargeGraph, // è¶…å¤§æ•°æ®é›†å…³é—­æ‚¬åœä»¥æå‡æ€§èƒ½
                    tooltipDelay: isVeryLargeGraph ? 300 : 100,
                    zoomView: true,
                    dragView: true,
                    selectConnectedEdges: !isVeryLargeGraph,
                    hideEdgesOnDrag: isVeryLargeGraph, // è¶…å¤§æ•°æ®é›†æ‹–æ‹½æ—¶éšè—è¾¹
                    hideEdgesOnZoom: isVeryLargeGraph // è¶…å¤§æ•°æ®é›†ç¼©æ”¾æ—¶éšè—è¾¹
                },
                nodes: {
                    borderWidth: isVeryLargeGraph ? 1 : (isLargeGraph ? 1 : 2),
                    shadow: {
                        enabled: !isVeryLargeGraph, // è¶…å¤§æ•°æ®é›†å…³é—­é˜´å½±
                        size: 10,
                        x: 5,
                        y: 5
                    },
                    font: {
                        size: isVeryLargeGraph ? 10 : (isLargeGraph ? 12 : 14),
                        face: 'Microsoft YaHei'
                    },
                    scaling: {
                        min: isVeryLargeGraph ? 8 : 10,
                        max: isVeryLargeGraph ? 25 : 30
                    },
                    chosen: {
                        node: function(values, id, selected, hovering) {
                            // é€‰ä¸­èŠ‚ç‚¹æ—¶é«˜äº®
                            if (selected || hovering) {
                                values.borderWidth = 3;
                                values.borderColor = '#667eea';
                            }
                        }
                    }
                },
                edges: {
                    shadow: {
                        enabled: !isVeryLargeGraph, // è¶…å¤§æ•°æ®é›†å…³é—­é˜´å½±
                        size: 5
                    },
                    width: isVeryLargeGraph ? 0.5 : (isLargeGraph ? 1 : 2),
                    font: {
                        size: isVeryLargeGraph ? 8 : (isLargeGraph ? 10 : 12),
                        face: 'Microsoft YaHei'
                    },
                    smooth: {
                        type: isVeryLargeGraph ? 'straightCross' : (isLargeGraph ? 'straightCross' : 'cubicBezier'),
                        roundness: 0.4
                    },
                    chosen: {
                        edge: function(values, id, selected, hovering) {
                            // é€‰ä¸­è¾¹æ—¶é«˜äº®
                            if (selected || hovering) {
                                values.width = 3;
                            }
                        }
                    }
                },
                layout: {
                    improvedLayout: !isVeryLargeGraph, // è¶…å¤§æ•°æ®é›†ä½¿ç”¨å¿«é€Ÿå¸ƒå±€
                    hierarchical: {
                        enabled: false // ä¸ä½¿ç”¨å±‚æ¬¡å¸ƒå±€ï¼Œä½¿ç”¨åŠ›å¯¼å‘å¸ƒå±€
                    }
                }
            };
            
            // æ·»åŠ é”™è¯¯å¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–
            try {
                network = new vis.Network(container, data, options);
                
                // å¤§æ•°æ®é›†æ—¶ä¼˜åŒ–æ€§èƒ½
                if (isVeryLargeGraph || isLargeGraph) {
                    network.on("stabilizationProgress", function(params) {
                        // æ˜¾ç¤ºç¨³å®šåŒ–è¿›åº¦
                        if (params.iterations % 10 === 0) {
                            console.log(`ç¨³å®šåŒ–è¿›åº¦: ${params.iterations}/${params.total}`);
                        }
                        // ç¨³å®šåŒ–å®Œæˆåï¼Œå¦‚æœèŠ‚ç‚¹æ•°å¾ˆå¤§ï¼Œå¯ä»¥å…³é—­ç‰©ç†å¼•æ“ä»¥æé«˜æ€§èƒ½
                        if (params.iterations === params.total && isVeryLargeGraph) {
                            // è¶…å¤§æ•°æ®é›†ç¨³å®šåŒ–åè‡ªåŠ¨å…³é—­ç‰©ç†å¼•æ“
                            setTimeout(function() {
                                network.setOptions({ physics: false });
                                physicsEnabled = false;
                            }, 1000);
                        }
                    });
                }
                
                // ç›‘å¬é”™è¯¯
                network.on("error", function(params) {
                    console.error("Network error:", params);
                });
            } catch (error) {
                console.error("Failed to initialize network:", error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;"><h3>å¯è§†åŒ–åŠ è½½å¤±è´¥</h3><p>æ•°æ®é‡è¿‡å¤§ï¼Œè¯·å°è¯•å‡å°‘æ˜¾ç¤ºçš„æ•°æ®é‡</p><p>èŠ‚ç‚¹æ•°: ' + nodeCount + ', è¾¹æ•°: ' + edgeCount + '</p></div>';
                return;
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨å®é™…çš„æ•°æ®é•¿åº¦ï¼‰
            const displayedNodes = nodes.length;
            const displayedEdges = edges.length;
            
            console.log("Updating stats:", displayedNodes, "nodes,", displayedEdges, "edges");
            
            document.getElementById('node-count').textContent = displayedNodes;
            document.getElementById('edge-count').textContent = displayedEdges;
            document.getElementById('type-count').textContent = graphData.nodeTypes ? graphData.nodeTypes.length : 0;
            
            // å¦‚æœæœ‰é‡‡æ ·ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ€»æ•°
            if (graphData.stats) {
                const stats = graphData.stats;
                const nodeTotalEl = document.getElementById('node-total');
                const edgeTotalEl = document.getElementById('edge-total');
                
                if (stats.total_nodes > displayedNodes && nodeTotalEl) {
                    nodeTotalEl.textContent = `(å…± ${stats.total_nodes} ä¸ª)`;
                }
                if (stats.total_edges > displayedEdges && edgeTotalEl) {
                    edgeTotalEl.textContent = `(å…± ${stats.total_edges} æ¡)`;
                }
                if (stats.sampled) {
                    const noticeEl = document.getElementById('sampling-notice');
                    if (noticeEl) {
                        noticeEl.style.display = 'block';
                    }
                }
            }
            
            // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (displayedNodes === 0) {
                console.error("No nodes to display!");
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;"><h3>æ— æ•°æ®å¯æ˜¾ç¤º</h3><p>èŠ‚ç‚¹æ•°ä¸º0ï¼Œè¯·æ£€æŸ¥æ•°æ®åŠ è½½</p></div>';
            }
            
            // åˆ›å»ºå›¾ä¾‹
            createLegend();
            
            // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
            network.on("click", function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    highlightEntityInText(nodeId);
                }
            });
        }
        
        function createLegend() {
            const legendContainer = document.getElementById('legend');
            legendContainer.innerHTML = '';
            
            graphData.nodeTypes.forEach(type => {
                const node = graphData.nodes.find(n => n.type === type);
                if (node) {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `
                        <div class="legend-color" style="background: ${node.color}"></div>
                        <span class="legend-label">${type}</span>
                    `;
                    legendContainer.appendChild(item);
                }
            });
        }
        
        function highlightEntityInText(nodeId) {
            const node = graphData.nodes.find(n => n.id === nodeId);
            if (!node) return;
            
            // é«˜äº®æ–‡æœ¬ä¸­çš„å®ä½“
            const textElements = document.querySelectorAll('.text-entity');
            textElements.forEach(el => {
                if (el.getAttribute('data-entity-id') === nodeId) {
                    el.style.background = 'linear-gradient(120deg, #ff6b6b 0%, #ee5a6f 100%)';
                    el.style.color = 'white';
                    setTimeout(() => {
                        el.style.background = '';
                        el.style.color = '';
                    }, 2000);
                }
            });
        }
        
        function resetView() {
            if (network) {
                network.fit();
            }
        }
        
        function fitView() {
            if (network) {
                network.fit({
                    animation: true
                });
            }
        }
        
        
        // ä¸ºåŸæ–‡é«˜äº®ä¸­çš„å®ä½“æ·»åŠ ç‚¹å‡»äº‹ä»¶
        function setupHighlightedTextEvents() {
            const container = document.getElementById('highlighted-text');
            if (!container) return;
            
            // ä¸ºæ‰€æœ‰å®ä½“spanæ·»åŠ ç‚¹å‡»äº‹ä»¶
            const entitySpans = container.querySelectorAll('.text-entity');
            entitySpans.forEach(span => {
                const entityId = span.getAttribute('data-entity-id');
                if (entityId && !span.onclick) {
                    span.style.cursor = 'pointer';
                    span.onclick = () => {
                        // ç‚¹å‡»å®ä½“æ—¶é«˜äº®å›¾ä¸­çš„èŠ‚ç‚¹
                        if (network) {
                            // å…ˆæ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                            network.unselectAll();
                            // é€‰ä¸­å¹¶èšç„¦åˆ°è¯¥èŠ‚ç‚¹
                            network.selectNodes([entityId]);
                            network.focus(entityId, {
                                scale: 1.5,
                                animation: true
                            });
                        }
                    };
                }
            });
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            initGraph();
            // å»¶è¿Ÿä¸€ä¸‹å†è®¾ç½®äº‹ä»¶ï¼Œç¡®ä¿HTMLå·²ç»åŠ è½½
            setTimeout(function() {
                setupHighlightedTextEvents();
            }, 200);
        });
    </script>
</body>
</html>